<!DOCTYPE html>

<head>
    <title>FightPicks League</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        .dt-container .row {
            margin: 0 !important;
        }

        .dt-container .row div {
            padding: 0 !important;
        }

        canvas {
            min-height: min(40vmax, 640px) !important;
        }
    </style>
</head>

<body data-bs-theme="dark">
    <div class="container">

        <h1 class="text-center mt-3">FightPicks League</h1>

        <!-- League Table Card -->
        <div class="card mt-3">
            <div class="card-header">
                <h3 class="text-center mb-0">League Table</h3>
            </div>
            <div class="card-body p-0 text-nowrap">
                <div class="table-responsive">
                    <table id="league-table" class="table table-sm table-striped m-0"></table>
                </div>
            </div>
            <div class="card-footer text-center">
                <div class="btn-group" role="group">
                    <button id="league-table-chart-btn" class="btn btn-sm btn-info">Points Chart</button>
                    <button id="league-percent-chart-btn" class="btn btn-sm btn-info">Percentage Chart</button>
                    <button id="league-gap-chart-btn" class="btn btn-sm btn-info">Gap Chart</button>
                    <button id="league-elo-chart-btn" class="btn btn-sm btn-info">Elo Chart</button>
                </div>
            </div>
            <div id="league-table-container" class="card-body p-0 league-chart-container">
                <canvas id="league-table-canvas"></canvas>
            </div>
            <div id="league-percent-container" class="card-body p-0 league-chart-container">
                <canvas id="league-percent-canvas"></canvas>
            </div>
            <div id="league-gap-container" class="card-body p-0 league-chart-container">
                <canvas id="league-gap-canvas"></canvas>
            </div>
            <div id="league-elo-container" class="card-body p-0 league-chart-container">
                <canvas id="league-elo-canvas"></canvas>
            </div>
        </div>

        <!-- Title History Card -->
        <div class="card mt-3">
            <div class="card-header">
                <h3 class="text-center mb-0">Title History</h3>
            </div>
            <div class="card-body p-0 text-nowrap">
                <div class="table-responsive">
                    <table id="title-history" class="table table-sm table-striped m-0"></table>
                </div>
            </div>
            <div class="card-footer text-center">
                <button id="title-history-chart-btn" class="btn btn-sm btn-info">Points Chart</button>
            </div>
            <div id="title-history-container" class="card-body p-0">
                <canvas id="title-history-canvas"></canvas>
            </div>
        </div>

        <!-- Performance History Card -->
        <div class="card mt-3">
            <div class="card-header">
                <h3 class="text-center mb-0">Performance Ratings</h3>
            </div>
            <div class="card-body p-0 text-nowrap">
                <div class="table-responsive">
                    <table id="perf-history" class="table table-sm table-striped m-0"></table>
                </div>
            </div>
        </div>

        <!-- Event Results Card -->
        <div class="card mt-3 mb-3">
            <div class="card-header">
                <h3 class="text-center">Event Results</h3>
                <select id="event-result-select" class="form-control"></select>
            </div>
            <div class="card-body p-0 text-nowrap">
                <div class="table-responsive">
                    <table id="event-results" class="table table-sm table-striped m-0">
                        <thead>
                            <tr>
                                <th colspan="6"></th>
                                <th colspan="6" class="text-center">Alex</th>
                                <th colspan="6" class="text-center">Kieran</th>
                                <th colspan="6" class="text-center">Rob</th>
                                <th colspan="6" class="text-center">Jake</th>
                            </tr>
                            <tr>
                                <th>#</th>
                                <th>Fight</th>
                                <th>Winner</th>
                                <th>M.</th>
                                <th>R.</th>
                                <th>*</th>

                                <th>Pick</th>
                                <th>M.</th>
                                <th>R.</th>
                                <th>Pts.</th>
                                <th>£+/-</th>
                                <th>Total</th>

                                <th>Pick</th>
                                <th>M.</th>
                                <th>R.</th>
                                <th>Pts.</th>
                                <th>£+/-</th>
                                <th>Total</th>

                                <th>Pick</th>
                                <th>M.</th>
                                <th>R.</th>
                                <th>Pts.</th>
                                <th>£+/-</th>
                                <th>Total</th>

                                <th>Pick</th>
                                <th>M.</th>
                                <th>R.</th>
                                <th>Pts.</th>
                                <th>£+/-</th>
                                <th>Total</th>
                            </tr>

                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer text-center">
                <button id="event-result-chart-btn" class="btn btn-sm btn-info">Points Chart</button>
            </div>
            <div id="event-result-container" class="card-body p-0">
                <canvas id="event-result-canvas"></canvas>
            </div>
        </div>

        <!-- Player Records Card -->
        <div class="card mt-3 mb-3">
            <div class="card-header">
                <h3 class="text-center">Player Records</h3>
            </div>
            <div class="card-body p-0 text-nowrap">
                <div class="table-responsive">
                    <table id="player-records" class="table table-sm table-striped m-0">
                        <thead>
                            <tr>
                                <th></th>
                                <th colspan="3">Best</th>
                                <th colspan="3">Worst</th>
                            </tr>
                            <tr>
                                <th>Record</th>
                                <th>Player</th>
                                <th>Score</th>
                                <th>Event</th>
                                <th>Player</th>
                                <th>Score</th>
                                <th>Event</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/2.2.1/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.2.1/js/dataTables.bootstrap5.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/2.2.1/sorting/currency.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Data Import -->
    <script>
        // Imported json from fight tracker sheet.
        const fightData = [
            { Card: 'UFC 300: Pereira vs Hill', Date: '2024-04-13', Left: 'Deiveson Figueiredo', Right: 'Cody Garbrandt', LeftLine: 1.33, RightLine: 3.4, FiveRound: false, Winner: 'Deiveson Figueiredo', Method: 'Submission', Round: '2', Picks: { Alex: { Pick: 'Deiveson Figueiredo', Method: 'Knockout', Round: '1' }, Kieran: { Pick: 'Deiveson Figueiredo', Method: 'Knockout', Round: '1' }, Rob: { Pick: 'Cody Garbrandt', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Deiveson Figueiredo', Method: 'Submission', Round: '2' }, } },
            { Card: 'UFC 300: Pereira vs Hill', Date: '2024-04-13', Left: 'Bobby Green', Right: 'Jim Miller', LeftLine: 1.57, RightLine: 2.5, FiveRound: false, Winner: 'Bobby Green', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Bobby Green', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Bobby Green', Method: 'Decision', Round: 'D' }, Rob: { Pick: 'Bobby Green', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Jim Miller', Method: 'Submission', Round: '2' }, } },
            { Card: 'UFC 300: Pereira vs Hill', Date: '2024-04-13', Left: 'Jessica Andrade', Right: 'Marina Rodriguez', LeftLine: 1.8, RightLine: 2, FiveRound: false, Winner: 'Jessica Andrade', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Jessica Andrade', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Marina Rodriguez', Method: 'Decision', Round: 'D' }, Rob: { Pick: 'Jessica Andrade', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Jessica Andrade', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC 300: Pereira vs Hill', Date: '2024-04-13', Left: 'Jalin Turner', Right: 'Renato Moicano', LeftLine: 1.4, RightLine: 3, FiveRound: false, Winner: 'Jalin Turner', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Jalin Turner', Method: 'Knockout', Round: '3' }, Kieran: { Pick: 'Jalin Turner', Method: 'Knockout', Round: '1' }, Rob: { Pick: 'Jalin Turner', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Jalin Turner', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC 300: Pereira vs Hill', Date: '2024-04-13', Left: 'Sodiq Yusuff', Right: 'Diego Lopes', LeftLine: 2.1, RightLine: 1.72, FiveRound: false, Winner: 'Diego Lopes', Method: 'Knockout', Round: '1', Picks: { Alex: { Pick: 'Sodiq Yusuff', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Diego Lopes', Method: 'Knockout', Round: '1' }, Rob: { Pick: 'Diego Lopes', Method: 'Knockout', Round: '1' }, Jake: { Pick: 'Diego Lopes', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC 300: Pereira vs Hill', Date: '2024-04-13', Left: 'Holly Holm', Right: 'Kayla Harrison', LeftLine: 4.5, RightLine: 1.22, FiveRound: false, Winner: 'Kayla Harrison', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Kayla Harrison', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Kayla Harrison', Method: 'Decision', Round: 'D' }, Rob: { Pick: 'Kayla Harrison', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Kayla Harrison', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC 300: Pereira vs Hill', Date: '2024-04-13', Left: 'Calvin Kattar', Right: 'Aljamain Sterling', LeftLine: 2.4, RightLine: 1.58, FiveRound: false, Winner: 'Aljamain Sterling', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Aljamain Sterling', Method: 'Submission', Round: '2' }, Kieran: { Pick: 'Aljamain Sterling', Method: 'Decision', Round: 'D' }, Rob: { Pick: 'Aljamain Sterling', Method: 'Knockout', Round: '2' }, Jake: { Pick: 'Aljamain Sterling', Method: 'Knockout', Round: '2' }, } },
            { Card: 'UFC 300: Pereira vs Hill', Date: '2024-04-13', Left: 'Jiri Prochazka', Right: 'Aleksandar Rakic', LeftLine: 2, RightLine: 1.8, FiveRound: false, Winner: 'Jiri Prochazka', Method: 'Knockout', Round: '2', Picks: { Alex: { Pick: 'Jiri Prochazka', Method: 'Knockout', Round: '1' }, Kieran: { Pick: 'Jiri Prochazka', Method: 'Knockout', Round: '1' }, Rob: { Pick: 'Jiri Prochazka', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Aleksandar Rakic', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC 300: Pereira vs Hill', Date: '2024-04-13', Left: 'Bo Nickal', Right: 'Cody Brundage', LeftLine: 1.05, RightLine: 11, FiveRound: false, Winner: 'Bo Nickal', Method: 'Submission', Round: '2', Picks: { Alex: { Pick: 'Bo Nickal', Method: 'Submission', Round: '1' }, Kieran: { Pick: 'Bo Nickal', Method: 'Knockout', Round: '2' }, Rob: { Pick: 'Bo Nickal', Method: 'Knockout', Round: '2' }, Jake: { Pick: 'Bo Nickal', Method: 'Submission', Round: '1' }, } },
            { Card: 'UFC 300: Pereira vs Hill', Date: '2024-04-13', Left: 'Charles Oliveira', Right: 'Arman Tsarukyan', LeftLine: 2.87, RightLine: 1.44, FiveRound: false, Winner: 'Arman Tsarukyan', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Arman Tsarukyan', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Charles Oliveira', Method: 'Submission', Round: '2' }, Rob: { Pick: 'Charles Oliveira', Method: 'Submission', Round: '2' }, Jake: { Pick: 'Charles Oliveira', Method: 'Knockout', Round: '2' }, } },
            { Card: 'UFC 300: Pereira vs Hill', Date: '2024-04-13', Left: 'Justin Gaethje', Right: 'Max Holloway', LeftLine: 1.57, RightLine: 2.5, FiveRound: true, Winner: 'Max Holloway', Method: 'Knockout', Round: '5', Picks: { Alex: { Pick: 'Justin Gaethje', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Justin Gaethje', Method: 'Knockout', Round: '2' }, Rob: { Pick: 'Justin Gaethje', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Justin Gaethje', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC 300: Pereira vs Hill', Date: '2024-04-13', Left: 'Zhang Weili', Right: 'Yan Xiaonan', LeftLine: 1.25, RightLine: 4, FiveRound: true, Winner: 'Zhang Weili', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Zhang Weili', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Zhang Weili', Method: 'Knockout', Round: '2' }, Rob: { Pick: 'Zhang Weili', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Zhang Weili', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC 300: Pereira vs Hill', Date: '2024-04-13', Left: 'Alex Pereira', Right: 'Jamahal Hill', LeftLine: 1.8, RightLine: 2, FiveRound: true, Winner: 'Alex Pereira', Method: 'Knockout', Round: '1', Picks: { Alex: { Pick: 'Alex Pereira', Method: 'Knockout', Round: '2' }, Kieran: { Pick: 'Jamahal Hill', Method: 'Decision', Round: 'D' }, Rob: { Pick: 'Alex Pereira', Method: 'Knockout', Round: '3' }, Jake: { Pick: 'Alex Pereira', Method: 'Knockout', Round: '2' }, } },
            { Card: 'UFC 304: Edwards vs Muhammad', Date: '2024-07-27', Left: 'Shauna Bannon', Right: 'Alice Ardelean', LeftLine: 2.1, RightLine: 1.72, FiveRound: false, Winner: 'Shauna Bannon', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Shauna Bannon', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Shauna Bannon', Method: 'Decision', Round: 'D' }, Rob: { Pick: 'Alice Ardelean', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Shauna Bannon', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC 304: Edwards vs Muhammad', Date: '2024-07-27', Left: 'Mick Parkin', Right: 'Lukasz Brzeski', LeftLine: 1.5, RightLine: 2.7, FiveRound: false, Winner: 'Mick Parkin', Method: 'Knockout', Round: '1', Picks: { Alex: { Pick: 'Mick Parkin', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Mick Parkin', Method: 'Decision', Round: 'D' }, Rob: { Pick: 'Mick Parkin', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Mick Parkin', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC 304: Edwards vs Muhammad', Date: '2024-07-27', Left: 'Sam Patterson', Right: 'Kiefer Crosbie', LeftLine: 1.33, RightLine: 3.4, FiveRound: false, Winner: 'Sam Patterson', Method: 'Submission', Round: '1', Picks: { Alex: { Pick: 'Sam Patterson', Method: 'Submission', Round: '2' }, Kieran: { Pick: 'Sam Patterson', Method: 'Submission', Round: '2' }, Rob: { Pick: 'Sam Patterson', Method: 'Submission', Round: '2' }, Jake: { Pick: 'Sam Patterson', Method: 'Submission', Round: '2' }, } },
            { Card: 'UFC 304: Edwards vs Muhammad', Date: '2024-07-27', Left: 'Modestas Bukauskas', Right: 'Marcin Prachnio', LeftLine: 1.66, RightLine: 2.25, FiveRound: false, Winner: 'Modestas Bukauskas', Method: 'Submission', Round: '3', Picks: { Alex: { Pick: 'Modestas Bukauskas', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Modestas Bukauskas', Method: 'Decision', Round: 'D' }, Rob: { Pick: 'Modestas Bukauskas', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Modestas Bukauskas', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC 304: Edwards vs Muhammad', Date: '2024-07-27', Left: 'Oban Elliott', Right: 'Preston Parsons', LeftLine: 2.25, RightLine: 1.66, FiveRound: false, Winner: 'Oban Elliott', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Oban Elliott', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Preston Parsons', Method: 'Decision', Round: 'D' }, Rob: { Pick: 'Oban Elliott', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Oban Elliott', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC 304: Edwards vs Muhammad', Date: '2024-07-27', Left: 'Muhammad Mokaev', Right: 'Manel Kape', LeftLine: 1.8, RightLine: 2, FiveRound: false, Winner: 'Muhammad Mokaev', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Muhammad Mokaev', Method: 'Submission', Round: '1' }, Kieran: { Pick: 'Muhammad Mokaev', Method: 'Submission', Round: '3' }, Rob: { Pick: 'Muhammad Mokaev', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Muhammad Mokaev', Method: 'Submission', Round: '3' }, } },
            { Card: 'UFC 304: Edwards vs Muhammad', Date: '2024-07-27', Left: 'Caolan Loughran', Right: 'Jake Hadley', LeftLine: 1.53, RightLine: 2.62, FiveRound: false, Winner: 'Jake Hadley', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Caolan Loughran', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Caolan Loughran', Method: 'Decision', Round: 'D' }, Rob: { Pick: 'Caolan Loughran', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Jake Hadley', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC 304: Edwards vs Muhammad', Date: '2024-07-27', Left: 'Molly McCann', Right: 'Bruna Brasil', LeftLine: 1.4, RightLine: 3, FiveRound: false, Winner: 'Bruna Brasil', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Molly McCann', Method: 'Knockout', Round: '2' }, Kieran: { Pick: 'Molly McCann', Method: 'Knockout', Round: '2' }, Rob: { Pick: 'Molly McCann', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Molly McCann', Method: 'Submission', Round: '1' }, } },
            { Card: 'UFC 304: Edwards vs Muhammad', Date: '2024-07-27', Left: 'Nathaniel Wood', Right: 'Daniel Pineda', LeftLine: 1.25, RightLine: 4, FiveRound: false, Winner: 'Nathaniel Wood', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Nathaniel Wood', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Nathaniel Wood', Method: 'Decision', Round: 'D' }, Rob: { Pick: 'Nathaniel Wood', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Nathaniel Wood', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC 304: Edwards vs Muhammad', Date: '2024-07-27', Left: 'Arnold Allen', Right: 'Giga Chikadze', LeftLine: 1.4, RightLine: 3, FiveRound: false, Winner: 'Arnold Allen', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Arnold Allen', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Arnold Allen', Method: 'Decision', Round: 'D' }, Rob: { Pick: 'Arnold Allen', Method: 'Knockout', Round: '2' }, Jake: { Pick: 'Arnold Allen', Method: 'Knockout', Round: '1' }, } },
            { Card: 'UFC 304: Edwards vs Muhammad', Date: '2024-07-27', Left: 'Christian Duncan', Right: 'Gregory Rodrigues', LeftLine: 1.8, RightLine: 2, FiveRound: false, Winner: 'Gregory Rodrigues', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Christian Duncan', Method: 'Knockout', Round: '2' }, Kieran: { Pick: 'Gregory Rodrigues', Method: 'Knockout', Round: '2' }, Rob: { Pick: 'Christian Duncan', Method: 'Knockout', Round: '3' }, Jake: { Pick: 'Christian Duncan', Method: 'Knockout', Round: '2' }, } },
            { Card: 'UFC 304: Edwards vs Muhammad', Date: '2024-07-27', Left: 'Bobby Green', Right: 'Paddy Pimblett', LeftLine: 1.72, RightLine: 2.1, FiveRound: false, Winner: 'Paddy Pimblett', Method: 'Submission', Round: '1', Picks: { Alex: { Pick: 'Paddy Pimblett', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Paddy Pimblett', Method: 'Submission', Round: '2' }, Rob: { Pick: 'Paddy Pimblett', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Paddy Pimblett', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC 304: Edwards vs Muhammad', Date: '2024-07-27', Left: 'Tom Aspinall', Right: 'Curtis Blaydes', LeftLine: 1.36, RightLine: 3.25, FiveRound: true, Winner: 'Tom Aspinall', Method: 'Knockout', Round: '1', Picks: { Alex: { Pick: 'Tom Aspinall', Method: 'Knockout', Round: '1' }, Kieran: { Pick: 'Tom Aspinall', Method: 'Knockout', Round: '2' }, Rob: { Pick: 'Tom Aspinall', Method: 'Knockout', Round: '2' }, Jake: { Pick: 'Tom Aspinall', Method: 'Knockout', Round: '1' }, } },
            { Card: 'UFC 304: Edwards vs Muhammad', Date: '2024-07-27', Left: 'Leon Edwards', Right: 'Belal Muhammad', LeftLine: 1.5, RightLine: 2.7, FiveRound: true, Winner: 'Belal Muhammad', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Leon Edwards', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Leon Edwards', Method: 'Decision', Round: 'D' }, Rob: { Pick: 'Leon Edwards', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Leon Edwards', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC Fight Night: Adesanya vs Imavov', Date: '2025-02-01', Left: 'Hamdy Abdelwahab', Right: 'Jamal Pogues', LeftLine: 1.9, RightLine: 1.9, FiveRound: false, Winner: 'Hamdy Abdelwahab', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Hamdy Abdelwahab', Method: 'Knockout', Round: '1' }, Kieran: { Pick: 'Jamal Pogues', Method: 'Decision', Round: 'D' }, Rob: { Pick: 'Hamdy Abdelwahab', Method: 'Knockout', Round: '3' }, Jake: { Pick: 'Hamdy Abdelwahab', Method: 'Knockout', Round: '1' }, } },
            { Card: 'UFC Fight Night: Adesanya vs Imavov', Date: '2025-02-01', Left: 'Bogdan Grad', Right: 'Lucas Alexander', LeftLine: 2, RightLine: 1.8, FiveRound: false, Winner: 'Bogdan Grad', Method: 'Knockout', Round: '2', Picks: { Alex: { Pick: 'Bogdan Grad', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Bogdan Grad', Method: 'Knockout', Round: '1' }, Rob: { Pick: 'Bogdan Grad', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Bogdan Grad', Method: 'Knockout', Round: '2' }, } },
            { Card: 'UFC Fight Night: Adesanya vs Imavov', Date: '2025-02-01', Left: 'Jasmine Jasudavicius', Right: 'Mayra Bueno Silva', LeftLine: 1.4, RightLine: 3, FiveRound: false, Winner: 'Jasmine Jasudavicius', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Jasmine Jasudavicius', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Jasmine Jasudavicius', Method: 'Submission', Round: '3' }, Rob: { Pick: 'Mayra Bueno Silva', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Jasmine Jasudavicius', Method: 'Submission', Round: '3' }, } },
            { Card: 'UFC Fight Night: Adesanya vs Imavov', Date: '2025-02-01', Left: 'Terrance McKinney', Right: 'Damir Hadzovic', LeftLine: 1.22, RightLine: 4.5, FiveRound: false, Winner: 'Terrance McKinney', Method: 'Knockout', Round: '1', Picks: { Alex: { Pick: 'Terrance McKinney', Method: 'Knockout', Round: '1' }, Kieran: { Pick: 'Terrance McKinney', Method: 'Knockout', Round: '2' }, Rob: { Pick: 'Terrance McKinney', Method: 'Knockout', Round: '1' }, Jake: { Pick: 'Terrance McKinney', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC Fight Night: Adesanya vs Imavov', Date: '2025-02-01', Left: 'Shamil Gaziev', Right: 'Thomas Petersen', LeftLine: 1.28, RightLine: 3.75, FiveRound: false, Winner: 'Shamil Gaziev', Method: 'Knockout', Round: '1', Picks: { Alex: { Pick: 'Shamil Gaziev', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Shamil Gaziev', Method: 'Knockout', Round: '2' }, Rob: { Pick: 'Shamil Gaziev', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Shamil Gaziev', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC Fight Night: Adesanya vs Imavov', Date: '2025-02-01', Left: 'Muhammad Naimov', Right: 'Kaan Ofli', LeftLine: 1.33, RightLine: 3.4, FiveRound: false, Winner: 'Muhammad Naimov', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Muhammad Naimov', Method: 'Knockout', Round: '2' }, Kieran: { Pick: 'Kaan Ofli', Method: 'Submission', Round: '2' }, Rob: { Pick: 'Muhammad Naimov', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Muhammad Naimov', Method: 'Knockout', Round: '1' }, } },
            { Card: 'UFC Fight Night: Adesanya vs Imavov', Date: '2025-02-01', Left: 'Farès Ziam', Right: 'Mike Davis', LeftLine: 2.25, RightLine: 1.66, FiveRound: false, Winner: 'Farès Ziam', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Farès Ziam', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Mike Davis', Method: 'Submission', Round: '2' }, Rob: { Pick: 'Mike Davis', Method: 'Knockout', Round: '3' }, Jake: { Pick: 'Mike Davis', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC Fight Night: Adesanya vs Imavov', Date: '2025-02-01', Left: 'Said Nurmagomedov', Right: 'Vinicius Oliveira', LeftLine: 1.62, RightLine: 2.3, FiveRound: false, Winner: 'Vinicius Oliveira', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Said Nurmagomedov', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Said Nurmagomedov', Method: 'Submission', Round: '2' }, Rob: { Pick: 'Vinicius Oliveira', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Said Nurmagomedov', Method: 'Submission', Round: '1' }, } },
            { Card: 'UFC Fight Night: Adesanya vs Imavov', Date: '2025-02-01', Left: 'Sergei Pavlovic', Right: 'Jairzinho Rozenstruik', LeftLine: 1.3, RightLine: 3.5, FiveRound: false, Winner: 'Sergei Pavlovic', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Sergei Pavlovic', Method: 'Knockout', Round: '1' }, Kieran: { Pick: 'Sergei Pavlovic', Method: 'Knockout', Round: '1' }, Rob: { Pick: 'Sergei Pavlovic', Method: 'Knockout', Round: '1' }, Jake: { Pick: 'Sergei Pavlovic', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC Fight Night: Adesanya vs Imavov', Date: '2025-02-01', Left: 'Shara Magomedov', Right: 'Michael Page', LeftLine: 1.53, RightLine: 2.62, FiveRound: false, Winner: 'Michael Page', Method: 'Decision', Round: 'D', Picks: { Alex: { Pick: 'Michael Page', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Shara Magomedov', Method: 'Knockout', Round: '3' }, Rob: { Pick: 'Shara Magomedov', Method: 'Decision', Round: 'D' }, Jake: { Pick: 'Shara Magomedov', Method: 'Decision', Round: 'D' }, } },
            { Card: 'UFC Fight Night: Adesanya vs Imavov', Date: '2025-02-01', Left: 'Israel Adesanya', Right: 'Nassourdine Imavov', LeftLine: 1.61, RightLine: 2.37, FiveRound: true, Winner: 'Nassourdine Imavov', Method: 'Knockout', Round: '2', Picks: { Alex: { Pick: 'Israel Adesanya', Method: 'Decision', Round: 'D' }, Kieran: { Pick: 'Israel Adesanya', Method: 'Decision', Round: 'D' }, Rob: { Pick: 'Israel Adesanya', Method: 'Knockout', Round: '2' }, Jake: { Pick: 'Nassourdine Imavov', Method: 'Decision', Round: 'D' }, } },
        ];
    </script>

    <!-- Settings & Utilities -->
    <script>
        // Player List
        const players = ["Alex", "Kieran", "Rob", "Jake"];

        // Colours for Chart.js
        const CHART_COLORS = {
            red: 'rgb(255, 99, 132)',
            yellow: 'rgb(255, 205, 86)',
            green: 'rgb(75, 192, 192)',
            blue: 'rgb(54, 162, 235)'
        };

        // Imported data grouped by event.
        var cardData = Object.groupBy(fightData, ({ Card }) => Card);

        // Formatter for currency fields.
        let gbpFormat = new Intl.NumberFormat('en-GB', {
            style: 'currency',
            currency: 'GBP',
        });

        // Formatter for percentage fields.
        function formatPercentage(num) {
            return Number(num).toLocaleString(undefined, { style: 'percent', minimumFractionDigits: 2 });
        }

        // Formatter for elo fields.
        function formatElo(num) {
            return Number(num).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Formatter for method fields.
        function shortMethod(method) {
            switch (method) {
                case "Knockout":
                    return "KO";
                case "Submission":
                    return "Sub";
                case "Decision":
                    return "Dec";
            }
        }

        // Chart.js default configuration.
        Chart.defaults.scale.ticks.color = "#dee2e6";
        Chart.defaults.scale.grid.color = "#343a40";
        Chart.defaults.plugins.legend.position = "bottom";
        Chart.defaults.plugins.legend.labels.color = "#dee2e6";
        Chart.defaults.maintainAspectRatio = false;
        Chart.defaults.elements.point.radius = 0;

        // Datatable default configuration.
        Object.assign(DataTable.defaults, {
            paging: false,
            searching: false,
            info: false,
            responsive: true,
        });
    </script>

    <!-- Chart Initialisation -->
    <script>
        var leagueChartOptions = {
            scales: {
                x: {
                    ticks: {
                        callback: function (a, b) {
                            var labelText = leagueTableChartLabels[a];
                            if (labelText.length > 0) return labelText;
                            return null;
                        },
                        align: 'end',
                        display: true,
                        autoSkip: false,
                    }
                }
            }
        };

        var leagueTableChartLabels = [];
        var eventResultChartVisible = false;
        var currentLeagueChartVisible = '';

        var leagueTableChart = new Chart(document.getElementById("league-table-canvas"), {
            type: 'line',
            options: leagueChartOptions
        });
        var leaguePercentChart = new Chart(document.getElementById("league-percent-canvas"), {
            type: 'line',
            options: leagueChartOptions
        });
        var leagueGapChart = new Chart(document.getElementById("league-gap-canvas"), {
            type: 'line',
            options: leagueChartOptions
        });
        var leagueEloChart = new Chart(document.getElementById("league-elo-canvas"), {
            type: 'line',
            options: leagueChartOptions
        });
        var titleHistoryChart = new Chart(document.getElementById("title-history-canvas"), {
            type: 'bar',
            options: {}
        });
        var eventResultChart = new Chart(document.getElementById("event-result-canvas"), {
            type: 'line',
            options: {
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 90,
                            minRotation: 90
                        }
                    }
                }
            }
        });

        function getNewChartData() {
            return {
                labels: [],
                datasets: [
                    { label: 'Alex', data: [], borderColor: CHART_COLORS.blue, backgroundColor: CHART_COLORS.blue },
                    { label: 'Kieran', data: [], borderColor: CHART_COLORS.green, backgroundColor: CHART_COLORS.green },
                    { label: 'Rob', data: [], borderColor: CHART_COLORS.yellow, backgroundColor: CHART_COLORS.yellow },
                    { label: 'Jake', data: [], borderColor: CHART_COLORS.red, backgroundColor: CHART_COLORS.red },
                ]
            };
        }
    </script>

    <!-- Record Tracker Initialisation -->
    <script>
        var winStreakRecord = { Event: '', Player: '', Score: 0 };
        var lossStreakRecord = { Event: '', Player: '', Score: 0 };
        var trebleStreakRecord = { Event: '', Player: '', Score: 0 };
        var noTrebleStreakRecord = { Event: '', Player: '', Score: 0 };
        var profitRecord = { Event: '', Player: '', Score: 0 };
        var lossRecord = { Event: '', Player: '', Score: 0 };
        var profitPercentRecord = { Event: '', Player: '', Score: 0 };
        var lossPercentRecord = { Event: '', Player: '', Score: 0 };
        var correctPercentRecord = { Event: '', Player: '', Score: 0 };
        var incorrectPercentRecord = { Event: '', Player: '', Score: 1 };
        var correctPicksRecord = { Event: '', Player: '', Score: 0 };
        var incorrectPicksRecord = { Event: '', Player: '', Score: 100 };
        var accuracyRecord = { Event: '', Player: '', Score: 0 };
        var pointsRecord = { Event: '', Player: '', Score: 0 };
        var lowAccuracyRecord = { Event: '', Player: '', Score: 1 };
        var lowPointsRecord = { Event: '', Player: '', Score: 100 };
        var eloRecord = { Event: '', Player: '', Score: 0 };
        var lowEloRecord = { Event: '', Player: '', Score: 100 };
        var perfRecord = { Event: '', Player: '', Score: 0 };
        var lowPerfRecord = { Event: '', Player: '', Score: 100 };
    </script>

    <!-- Datatable Initialisation -->
    <script>
        var eventResultTable = new DataTable("#event-results", {
            order: [[0, "asc"]],
            columnDefs: [
                { className: 'table-info', targets: [6, 7, 8, 9, 10, 11] },
                { className: 'table-success', targets: [12, 13, 14, 15, 16, 17] },
                { className: 'table-warning', targets: [18, 19, 20, 21, 22, 23] },
                { className: 'table-danger', targets: [24, 25, 26, 27, 28, 29] }
            ]
        });
    </script>

    <!-- Chart Toggle Events -->
    <script>
        $("#event-result-chart-btn").click(function () {
            if (eventResultChartVisible) {
                $("#event-result-container").hide();
                eventResultChartVisible = false;
            }
            else {
                $("#event-result-container").show();
                eventResultChartVisible = true;
            }
        });

        $("#league-table-chart-btn").click(function () {
            toggleLeagueChart("league-table-container");
        });

        $("#league-elo-chart-btn").click(function () {
            toggleLeagueChart("league-elo-container");
        });

        $("#league-percent-chart-btn").click(function () {
            toggleLeagueChart("league-percent-container");
        });

        $("#league-gap-chart-btn").click(function () {
            toggleLeagueChart("league-gap-container");
        });

        $("#title-history-chart-btn").click(function () {
            $("#title-history-container").toggle();
        });

        function toggleLeagueChart(id) {
            $(".league-chart-container").hide();
            if (currentLeagueChartVisible == id) {
                $(`#${id}`).hide();
                currentLeagueChartVisible = "";
            }
            else {
                $(`#${id}`).show();
                currentLeagueChartVisible = id;
            }
        }
    </script>

    <!-- Table & Chart Setup-->
    <script>

        // Calculates league data and title history.
        function generateLeagueTable() {
            // Generate a record for each player.
            var playerInfo = {};
            for (var px in players) {
                var player = players[px];
                playerInfo[player] = {
                    Correct: 0,
                    Methods: 0,
                    Rounds: 0,
                    Trebles: 0,
                    Points: 0,
                    Profit: 0,
                    Titles: 0
                };
            }

            // Generate a record for each card.
            var cardInfo = {};
            for (var cardName in cardData) {
                var cardDate = cardData[cardName][0].Date;
                cardInfo[cardName] = {
                    Date: cardDate,
                    MaxPts: 0,
                    Alex: 0,
                    Kieran: 0,
                    Rob: 0,
                    Jake: 0,
                    Champion: "",
                    Accuracy: 0
                };
            }

            // Generate new chart data objects for each chart.
            var chartData = getNewChartData();
            var titleData = getNewChartData();
            var chartPercentData = getNewChartData();
            var chartGapData = getNewChartData();

            // Configure records to track.
            var winStreaks = { Alex: 0, Kieran: 0, Rob: 0, Jake: 0 };
            var scorelessStreaks = { Alex: 0, Kieran: 0, Rob: 0, Jake: 0 };
            var trebleStreaks = { Alex: 0, Kieran: 0, Rob: 0, Jake: 0 };
            var noTrebleStreaks = { Alex: 0, Kieran: 0, Rob: 0, Jake: 0 };

            var pointTotals = { Alex: 0, Kieran: 0, Rob: 0, Jake: 0 };

            // Calculate scores for each player.
            var lastCard = "";
            for (var cardName in cardData) {
                var card = cardData[cardName];

                // Container for total card scores.
                var cardScores = {};
                var cardTrebles = { Alex: 0, Kieran: 0, Rob: 0, Jake: 0 };

                // Configure card stats to track.
                var cardProfit = { Alex: 0, Kieran: 0, Rob: 0, Jake: 0 };
                var cardCorrect = { Alex: 0, Kieran: 0, Rob: 0, Jake: 0 };

                var cardTotals = { Alex: 0, Kieran: 0, Rob: 0, Jake: 0 };

                // Process each fight in the current card.
                for (var fx in card) {
                    var fight = card[fx];

                    // Update the maximum possible card score.
                    var maxPts = fight.FiveRound ? 30 : 15;
                    cardInfo[cardName].MaxPts += maxPts;

                    // Add the league card label if it's the last fight on the card.
                    if (fx == card.length - 1) {
                        chartData.labels.push(cardName);
                    }
                    else {
                        chartData.labels.push("");
                    }

                    // Update the player data for this fight.
                    for (var px in players) {
                        var player = players[px];

                        // Calculate the correctness of picks, methods, rounds and trebles.
                        var pick = fight.Picks[player];
                        var isCorrect = pick.Pick == fight.Winner;
                        var isMethod = isCorrect && pick.Method == fight.Method;
                        var isRound = isCorrect && pick.Round == fight.Round;
                        var isTreble = isCorrect && isMethod && isRound;

                        var score = 0;
                        if (isCorrect) score = 5;
                        if (isMethod) score = 7;
                        if (isRound) score = 8;
                        if (isTreble) score = 15;
                        if (fight.FiveRound) score *= 2;

                        cardTotals[player] += score;
                        pointTotals[player] += score;

                        pick.Points = score;
                        pick.Total = pointTotals[player];
                        pick.CardTotal = cardTotals[player];

                        var winnerLine = fight.Left == fight.Winner ? fight.LeftLine : fight.RightLine;
                        var profit = -1;
                        if (isCorrect) {
                            profit = winnerLine - 1;
                        }
                        pick.Profit = profit;

                        if (isCorrect) {
                            // Check for a new longest losing streak.
                            if (scorelessStreaks[player] > lossStreakRecord.Score) {
                                lossStreakRecord.Score = scorelessStreaks[player];
                                lossStreakRecord.Player = player;
                                lossStreakRecord.Event = cardName;
                            }

                            // Update scores.
                            cardCorrect[player]++;
                            playerInfo[player].Correct++;
                            winStreaks[player]++;
                            scorelessStreaks[player] = 0;
                        }
                        else {
                            // Check for a new longest winning streak.
                            if (winStreaks[player] > winStreakRecord.Score) {
                                winStreakRecord.Score = winStreaks[player];
                                winStreakRecord.Player = player;
                                winStreakRecord.Event = cardName;
                            }

                            // Update scores.
                            scorelessStreaks[player]++;
                            winStreaks[player] = 0;
                        }
                        if (isMethod) playerInfo[player].Methods++;
                        if (isRound) playerInfo[player].Rounds++;
                        if (isTreble) {
                            // Check for a new longest non-treble streak.
                            if (noTrebleStreaks[player] > noTrebleStreakRecord.Score) {
                                noTrebleStreakRecord.Score = noTrebleStreaks[player];
                                noTrebleStreakRecord.Player = player;
                                noTrebleStreakRecord.Event = cardName;
                            }

                            // Update scores.
                            noTrebleStreaks[player] = 0;
                            playerInfo[player].Trebles++;
                            cardTrebles[player]++;
                            trebleStreaks[player]++;
                        }
                        else {
                            // Check for a new longest treble streak.
                            if (trebleStreaks[player] > trebleStreakRecord.Score) {
                                trebleStreakRecord.Score = trebleStreaks[player];
                                trebleStreakRecord.Player = player;
                                trebleStreakRecord.Event = cardName;
                            }

                            // Update scores.
                            trebleStreaks[player] = 0;
                            noTrebleStreaks[player]++;
                        }

                        // Update player's tracked scores.
                        cardProfit[player] += pick.Profit;
                        playerInfo[player].Points = pick.Total;
                        playerInfo[player].Profit += pick.Profit;
                        cardScores[player] = pick.CardTotal;
                        cardInfo[cardName][player] = pick.CardTotal;
                    }

                    // Update the current chart totals for the league table.
                    chartData.datasets[0].data.push(fight.Picks.Alex.Total);
                    chartData.datasets[1].data.push(fight.Picks.Kieran.Total);
                    chartData.datasets[2].data.push(fight.Picks.Rob.Total);
                    chartData.datasets[3].data.push(fight.Picks.Jake.Total);
                }

                // Determine the winner of the current card.
                var cardWinner = null;
                var winnerScore = 0;
                var winnerTrebles = 0;
                var winnerPicks = 0;
                for (var px in players) {
                    var player = players[px];
                    var score = cardScores[player];
                    if (score > winnerScore) {
                        winnerScore = score;
                        cardWinner = player;
                        winnerTrebles = cardTrebles[player];
                        winnerPicks = cardCorrect[player];
                    }
                    if (score == winnerScore) {
                        var treble = cardTrebles[player];
                        if (treble > winnerTrebles) {
                            winnerScore = score;
                            cardWinner = player;
                            winnerTrebles = treble;
                            winnerPicks = cardCorrect[player];
                        }
                        if (treble == winnerTrebles) {
                            var pick = cardCorrect[player];
                            if (pick > winnerPicks) {
                                winnerScore = score;
                                cardWinner = player;
                                winnerTrebles = treble;
                                winnerPicks = pick;
                            }
                        }
                    }
                }

                // Update tracked player records.
                for (var px in players) {
                    var player = players[px];
                    var picks = cardCorrect[player];
                    var pickPer = picks / card.length;
                    var profit = cardProfit[player];
                    var profitPer = profit / card.length;
                    if (picks > correctPicksRecord.Score) {
                        correctPicksRecord.Score = picks;
                        correctPicksRecord.Player = player;
                        correctPicksRecord.Event = cardName;
                    }
                    if (picks < incorrectPicksRecord.Score) {
                        incorrectPicksRecord.Score = picks;
                        incorrectPicksRecord.Player = player;
                        incorrectPicksRecord.Event = cardName;
                    }
                    if (pickPer > correctPercentRecord.Score) {
                        correctPercentRecord.Score = pickPer;
                        correctPercentRecord.Player = player;
                        correctPercentRecord.Event = cardName;
                    }
                    if (pickPer < incorrectPercentRecord.Score) {
                        incorrectPercentRecord.Score = pickPer;
                        incorrectPercentRecord.Player = player;
                        incorrectPercentRecord.Event = cardName;
                    }
                    if (profit > profitRecord.Score) {
                        profitRecord.Score = profit;
                        profitRecord.Player = player;
                        profitRecord.Event = cardName;
                    }
                    if (profit < lossRecord.Score) {
                        lossRecord.Score = profit;
                        lossRecord.Player = player;
                        lossRecord.Event = cardName;
                    }
                    if (profitPer > profitPercentRecord.Score) {
                        profitPercentRecord.Score = profitPer;
                        profitPercentRecord.Player = player;
                        profitPercentRecord.Event = cardName;
                    }
                    if (profitPer < lossPercentRecord.Score) {
                        lossPercentRecord.Score = profitPer;
                        lossPercentRecord.Player = player;
                        lossPercentRecord.Event = cardName;
                    }
                }

                // Update final card winner details for the title history.
                playerInfo[cardWinner].Titles++;
                cardInfo[cardName].Winner = cardWinner;
                cardInfo[cardName].Accuracy = winnerScore / cardInfo[cardName].MaxPts;

                // Track the last card name for some records later.
                lastCard = cardName;
            }

            // Calculate elo ratings of each player.
            calculateElo();

            // Check for any streaks that a player could currently hold the record.
            for (var px in players) {
                var player = players[px];
                var currentWinStreak = winStreaks[player];
                if (currentWinStreak > winStreakRecord.Score) {
                    winStreakRecord.Score = currentWinStreak;
                    winStreakRecord.Player = player;
                    winStreakRecord.Event = lastCard;
                }
                var currentLossStreak = scorelessStreaks[player];
                if (currentLossStreak > lossStreakRecord.Score) {
                    lossStreakRecord.Score = currentLossStreak;
                    lossStreakRecord.Player = player;
                    lossStreakRecord.Event = lastCard;
                }
                var currentTrebleStreak = trebleStreaks[player];
                if (currentTrebleStreak > trebleStreakRecord.Score) {
                    trebleStreakRecord.Score = currentTrebleStreak;
                    trebleStreakRecord.Player = player;
                    trebleStreakRecord.Event = lastCard;
                }
                var currentNoTrebleStreak = noTrebleStreaks[player];
                if (currentNoTrebleStreak > noTrebleStreakRecord.Score) {
                    noTrebleStreakRecord.Score = currentNoTrebleStreak;
                    noTrebleStreakRecord.Player = player;
                    noTrebleStreakRecord.Event = lastCard;
                }
            }

            // Generate individual row data for the league table.
            var leagueRows = [];
            for (var px in players) {
                var player = players[px];
                var result = playerInfo[player];
                var playerRow = [player, result.Correct, result.Methods, result.Rounds, result.Trebles, result.Points, result.Titles, gbpFormat.format(result.Profit), formatElo(eloRatings[player])];
                leagueRows.push(playerRow);
            }

            // Create the league datatable.
            var leagueTable = new DataTable("#league-table", {
                columns: [
                    { title: "Player" },
                    { title: "Correct" },
                    { title: "Method" },
                    { title: "Round" },
                    { title: "Treble" },
                    { title: "Points" },
                    { title: "Titles" },
                    { title: "Profit", type: "num-fmt" },
                    { title: "Elo" }
                ],
                order: [[5, "desc"]],
                data: leagueRows
            });

            // Generate individual row data for the title history table.
            var titleRows = [];
            for (var cardName in cardInfo) {
                var card = cardInfo[cardName];

                // Generate the datatable row.
                var cardRow = [card.Date, cardName, card.MaxPts, card.Alex, card.Kieran, card.Rob, card.Jake, card.Winner, formatPercentage(card.Accuracy)];
                titleRows.push(cardRow);

                // Generate the bar chart data.
                titleData.labels.push(cardName);
                titleData.datasets[0].data.push(card.Alex);
                titleData.datasets[1].data.push(card.Kieran);
                titleData.datasets[2].data.push(card.Rob);
                titleData.datasets[3].data.push(card.Jake);

                // Check for new best records.
                if (card.Accuracy > accuracyRecord.Score) {
                    accuracyRecord.Player = card.Winner;
                    accuracyRecord.Score = card.Accuracy;
                    accuracyRecord.Event = cardName;
                }
                if (card[card.Winner] > pointsRecord.Score) {
                    pointsRecord.Player = card.Winner;
                    pointsRecord.Score = card[card.Winner];
                    pointsRecord.Event = cardName;
                }

                // Check for new worst records.
                for (var px in players) {
                    var player = players[px];
                    var score = card[player];
                    var acc = score / card.MaxPts;
                    if (score < lowPointsRecord.Score) {
                        lowPointsRecord.Score = score;
                        lowPointsRecord.Player = player;
                        lowPointsRecord.Event = cardName;
                    }
                    if (acc < lowAccuracyRecord.Score) {
                        lowAccuracyRecord.Score = acc;
                        lowAccuracyRecord.Player = player;
                        lowAccuracyRecord.Event = cardName;
                    }
                }
            }

            // Create the title history datatable.
            var titleTable = new DataTable("#title-history", {
                order: [[0, "desc"]],
                columns: [
                    { title: "Date", type: "date" },
                    { title: "Event" },
                    { title: "Total" },
                    { title: "Alex" },
                    { title: "Kieran" },
                    { title: "Rob" },
                    { title: "Jake" },
                    { title: "Champ." },
                    { title: "% Pts" }
                ],
                data: titleRows
            });

            // Calculate chart data for league percentage and gap charts.
            for (var ix in chartData.labels) {
                chartPercentData.labels.push(chartData.labels[ix]);
                chartGapData.labels.push(chartData.labels[ix]);
                var bestScore = Math.max(chartData.datasets[0].data[ix], chartData.datasets[1].data[ix], chartData.datasets[2].data[ix], chartData.datasets[3].data[ix]);
                var worstScore = Math.min(chartData.datasets[0].data[ix], chartData.datasets[1].data[ix], chartData.datasets[2].data[ix], chartData.datasets[3].data[ix]);
                var totalGap = bestScore - worstScore;
                chartPercentData.datasets[0].data.push(chartData.datasets[0].data[ix] / bestScore);
                chartPercentData.datasets[1].data.push(chartData.datasets[1].data[ix] / bestScore);
                chartPercentData.datasets[2].data.push(chartData.datasets[2].data[ix] / bestScore);
                chartPercentData.datasets[3].data.push(chartData.datasets[3].data[ix] / bestScore);
                chartGapData.datasets[0].data.push((chartData.datasets[0].data[ix] - worstScore) / totalGap);
                chartGapData.datasets[1].data.push((chartData.datasets[1].data[ix] - worstScore) / totalGap);
                chartGapData.datasets[2].data.push((chartData.datasets[2].data[ix] - worstScore) / totalGap);
                chartGapData.datasets[3].data.push((chartData.datasets[3].data[ix] - worstScore) / totalGap);
            }

            // Generate individual row data for the performance history table.
            var perfRows = [];
            for (var cardName in cardInfo) {
                var card = cardInfo[cardName];
                var date = card.Date;
                perfRows.push([date, cardName, formatElo(perfRatings[cardName].Alex), formatElo(perfRatings[cardName].Kieran), formatElo(perfRatings[cardName].Rob), formatElo(perfRatings[cardName].Jake)]);
            }

            // Create the performance history datatable.
            var perfTable = new DataTable("#perf-history", {
                order: [[0, "desc"]],
                columns: [
                    { title: "Date", type: "date" },
                    { title: "Event" },
                    { title: "Alex" },
                    { title: "Kieran" },
                    { title: "Rob" },
                    { title: "Jake" }
                ],
                data: perfRows
            });

            // Update charts with new data.
            leagueTableChart.data = chartData;
            leagueTableChartLabels = chartData.labels;
            leagueTableChart.update();
            leaguePercentChart.data = chartPercentData;
            leaguePercentChart.update();
            leagueGapChart.data = chartGapData;
            leagueGapChart.update();
            titleHistoryChart.data = titleData;
            titleHistoryChart.update();
            eloChartData.labels = chartData.labels;
            leagueEloChart.update();

            // Hide all the configured charts.
            $("#league-table-container").hide();
            $("#league-percent-container").hide();
            $("#league-gap-container").hide();
            $("#title-history-container").hide();
            $("#league-elo-container").hide();
        }

        // Generates the event list and sets up the event table selector.
        function bindEventSelect() {
            var selectInput = $("#event-result-select");

            // Generate an option for each unique card.
            for (var cardName in cardData) {
                var cardDate = cardData[cardName][0].Date;
                var cardOption = $(`<option value='${cardName}'>[${cardDate}] ${cardName}</option>`);
                selectInput.prepend(cardOption);
                selectInput.val(cardName);
            }

            // Bind the input to re-bind the event table.
            selectInput.change(function () {
                generateEventTable();
            });
        }

        // Generates the event results table when the selected event changes.
        function generateEventTable() {
            var selectedCardName = $("#event-result-select").val();
            var cardFights = cardData[selectedCardName];

            // Show the chart container so that chart.js renders properly.
            $("#event-result-container").show();

            // Clear the existing data and prepare a new data object.
            eventResultTable.clear();
            var chartData = getNewChartData();

            // Generate a row for each fight.
            var fightRows = [];
            for (var ix in cardFights) {
                var fight = cardFights[ix];
                var fightName = `${fight.Left.split(" ")[1]} vs ${fight.Right.split(" ")[1]}`;
                var fightMulti = "";
                if (fight.FiveRound) { fightMulti = "2x" };

                // Generate the datatable row.
                var fightRow = [parseInt(ix) + 1, fightName, fight.Winner.split(" ")[1], shortMethod(fight.Method), fight.Round, fightMulti,
                fight.Picks.Alex.Pick.split(" ")[1], shortMethod(fight.Picks.Alex.Method), fight.Picks.Alex.Round, fight.Picks.Alex.Points, gbpFormat.format(fight.Picks.Alex.Profit), fight.Picks.Alex.CardTotal,
                fight.Picks.Kieran.Pick.split(" ")[1], shortMethod(fight.Picks.Kieran.Method), fight.Picks.Kieran.Round, fight.Picks.Kieran.Points, gbpFormat.format(fight.Picks.Kieran.Profit), fight.Picks.Kieran.CardTotal,
                fight.Picks.Rob.Pick.split(" ")[1], shortMethod(fight.Picks.Rob.Method), fight.Picks.Rob.Round, fight.Picks.Rob.Points, gbpFormat.format(fight.Picks.Rob.Profit), fight.Picks.Rob.CardTotal,
                fight.Picks.Jake.Pick.split(" ")[1], shortMethod(fight.Picks.Jake.Method), fight.Picks.Jake.Round, fight.Picks.Jake.Points, gbpFormat.format(fight.Picks.Jake.Profit), fight.Picks.Jake.CardTotal,
                ];
                fightRows.push(fightRow);

                // Add the chart data points.
                chartData.labels.push(fightName);
                chartData.datasets[0].data.push(fight.Picks.Alex.CardTotal);
                chartData.datasets[1].data.push(fight.Picks.Kieran.CardTotal);
                chartData.datasets[2].data.push(fight.Picks.Rob.CardTotal);
                chartData.datasets[3].data.push(fight.Picks.Jake.CardTotal);
            }

            // Refresh the datatable and chart with new data.
            eventResultTable.rows.add(fightRows);
            eventResultTable.draw();
            eventResultChart.data = chartData;
            eventResultChart.update();

            // If the chart wasn't already visible, hide it.
            if (!eventResultChartVisible) {
                $("#event-result-container").hide();
            }
        }

        // Generates the records table from league and title history.
        function generateRecordsTable() {
            // Generate rows for the records table.
            var recordRows = [
                ["Points Scored", pointsRecord.Player, pointsRecord.Score, pointsRecord.Event, lowPointsRecord.Player, lowPointsRecord.Score, lowPointsRecord.Event],
                ["Points Percentage", accuracyRecord.Player, formatPercentage(accuracyRecord.Score), accuracyRecord.Event, lowAccuracyRecord.Player, formatPercentage(lowAccuracyRecord.Score), lowAccuracyRecord.Event],
                ["Win/Loss Streak", winStreakRecord.Player, winStreakRecord.Score, winStreakRecord.Event, lossStreakRecord.Player, lossStreakRecord.Score, lossStreakRecord.Event],
                ["Treble/None Streak", trebleStreakRecord.Player, trebleStreakRecord.Score, trebleStreakRecord.Event, noTrebleStreakRecord.Player, noTrebleStreakRecord.Score, noTrebleStreakRecord.Event],
                ["Profit Earned", profitRecord.Player, gbpFormat.format(profitRecord.Score), profitRecord.Event, lossRecord.Player, gbpFormat.format(lossRecord.Score), lossRecord.Event],
                ["Correct Picks", correctPicksRecord.Player, correctPicksRecord.Score, correctPercentRecord.Event, incorrectPicksRecord.Player, incorrectPicksRecord.Score, incorrectPicksRecord.Event],
                ["Correct Percentage", correctPercentRecord.Player, formatPercentage(correctPercentRecord.Score), correctPercentRecord.Event, incorrectPercentRecord.Player, formatPercentage(incorrectPercentRecord.Score), incorrectPercentRecord.Event],
                ["Profit Percentage", profitPercentRecord.Player, formatPercentage(profitPercentRecord.Score), profitPercentRecord.Event, lossPercentRecord.Player, formatPercentage(lossPercentRecord.Score), lossPercentRecord.Event],
                ["Elo Rating", eloRecord.Player, formatElo(eloRecord.Score), eloRecord.Event, lowEloRecord.Player, formatElo(lowEloRecord.Score), lowEloRecord.Event],
                ["Performance Rating", perfRecord.Player, formatElo(perfRecord.Score), perfRecord.Event, lowPerfRecord.Player, formatElo(lowPerfRecord.Score), lowPerfRecord.Event]
            ];
            var recordTable = new DataTable("#player-records", { data: recordRows });
        }
    </script>

    <!-- Simple Elo Calculation -->
    <script>
        var eloRatings = {};
        var perfRatings = {};
        var eloChartData = getNewChartData();

        function calculateElo() {
            var k = 5;
            var defaultElo = 100;

            var lastCard = "";
            var cardScores = {
                Alex: 0,
                Kieran: 0,
                Rob: 0,
                Jake: 0
            };
            var opponentRatings = {
                Alex: [],
                Kieran: [],
                Rob: [],
                Jake: []
            };

            for (var p in players) {
                eloRatings[players[p]] = defaultElo;
            }

            for (var ix in fightData) {
                var fight = fightData[ix];

                if (lastCard != fight.Card && lastCard != "") {
                    perfRatings[lastCard] = {
                        Alex: performanceRating(opponentRatings.Alex, cardScores.Alex),
                        Kieran: performanceRating(opponentRatings.Kieran, cardScores.Kieran),
                        Rob: performanceRating(opponentRatings.Rob, cardScores.Rob),
                        Jake: performanceRating(opponentRatings.Jake, cardScores.Jake),
                    };
                    cardScores = { Alex: 0, Kieran: 0, Rob: 0, Jake: 0 };
                    opponentRatings = { Alex: [], Kieran: [], Rob: [], Jake: [] };
                }

                var priorRatings = {};
                for (var p in players) {
                    priorRatings[players[p]] = eloRatings[players[p]];
                }

                for (var p1 in players) {
                    for (var p2 in players) {
                        if (p2 > p1) {
                            var p1n = players[p1];
                            var p2n = players[p2];
                            var p1s = fight.Picks[p1n].Points;
                            var p2s = fight.Picks[p2n].Points;
                            var ms = fight.FiveRound ? 30 : 15;

                            var gap = Math.abs(p1s - p2s) / ms;
                            var winp = 0.5 + (gap / 2);
                            var p1score = 0.5;
                            var p2score = 0.5;

                            // Relative Treble.
                            if (p1s > p2s) {
                                p1score = winp;
                                p2score = 1 - winp;
                            }
                            if (p2s > p1s) {
                                p2score = winp;
                                p1score = 1 - winp;
                            }

                            // Relative Compared
                            var ttlPts = p1s + p2s;
                            if (ttlPts > 0) {
                                //p1score = p1s / ttlPts;
                                //p2score = p2s / ttlPts;
                            }

                            var prior1 = priorRatings[p1n];
                            var prior2 = priorRatings[p2n];
                            opponentRatings[p1n].push(prior2);
                            opponentRatings[p2n].push(prior1);
                            cardScores[p1n] += p1score;
                            cardScores[p2n] += p2score;

                            var newRatings = eloCalculate(priorRatings[p1n], priorRatings[p2n], p1score, p2score, k);
                            eloRatings[p1n] += (newRatings[0] - priorRatings[p1n]);
                            eloRatings[p2n] += (newRatings[1] - priorRatings[p2n]);
                        }
                    }
                }

                for (var p in players) {
                    var r = eloRatings[players[p]];
                    if (r > eloRecord.Score) {
                        eloRecord.Score = r;
                        eloRecord.Player = players[p];
                        eloRecord.Event = fight.Card;
                    }
                    if (r < lowEloRecord.Score) {
                        lowEloRecord.Score = r;
                        lowEloRecord.Player = players[p];
                        lowEloRecord.Event = fight.Card;
                    }
                }

                eloChartData.datasets[0].data.push(eloRatings.Alex);
                eloChartData.datasets[1].data.push(eloRatings.Kieran);
                eloChartData.datasets[2].data.push(eloRatings.Rob);
                eloChartData.datasets[3].data.push(eloRatings.Jake);
                leagueEloChart.data = eloChartData;

                var lastCard = fight.Card;
            }

            perfRatings[lastCard] = {
                Alex: performanceRating(opponentRatings.Alex, cardScores.Alex),
                Kieran: performanceRating(opponentRatings.Kieran, cardScores.Kieran),
                Rob: performanceRating(opponentRatings.Rob, cardScores.Rob),
                Jake: performanceRating(opponentRatings.Jake, cardScores.Jake),
            };

            for (var card in perfRatings) {
                for (var player in perfRatings[card]) {
                    if (perfRatings[card][player] > perfRecord.Score) {
                        perfRecord.Score = perfRatings[card][player];
                        perfRecord.Player = player;
                        perfRecord.Event = card;
                    }
                    if (perfRatings[card][player] < lowPerfRecord.Score) {
                        lowPerfRecord.Score = perfRatings[card][player];
                        lowPerfRecord.Player = player;
                        lowPerfRecord.Event = card;
                    }
                }
            }

            console.log(perfRatings);
        }

        function eloCalculate(ratingA, ratingB, scoreA, scoreB, k) {
            var exp = eloPredict(ratingA, ratingB);
            var newA = ratingA + (k * (scoreA - exp[0]));
            var newB = ratingB + (k * (scoreB - exp[1]));
            return [newA, newB];
        }

        function eloPredict(ratingA, ratingB) {
            var ea = 1 / (1 + Math.pow(10, (ratingB - ratingA) / 400));
            var eb = 1 / (1 + Math.pow(10, (ratingA - ratingB) / 400));
            return [ea, eb];
        }

        function performanceRating(opponentRatings, totalScore) {
            var lo = 0;
            var hi = 400;
            while (hi - lo > 1E-08) {
                mid = (lo + hi) / 2
                var expected = 0;
                for (var ix in opponentRatings) {
                    expected += eloPredict(mid, opponentRatings[ix])[0];
                }
                if (expected < totalScore) {
                    lo = mid;
                }
                else {
                    hi = mid;
                }
            }
            return mid;
        }
    </script>

    <!-- Startup Script -->
    <script>
        $(document).ready(function () {

            // Generate all the initial page data and load the league table and title history.
            generateLeagueTable();

            // Bind the event selector and generate the event results for the most recent event.
            bindEventSelect();
            generateEventTable();

            // Populate the records table with all the calculated records.
            generateRecordsTable();
        });
    </script>
</body>
