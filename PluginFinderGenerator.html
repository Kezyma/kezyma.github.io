<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" style="">
<head>
    <title>Plugin Generator</title>
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="lib/bootswatch/dist/darkly/bootstrap.min.css" />
    <link rel="stylesheet" href="lib/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="lib/prism-themes/prism-vsc-dark-plus.css" />
    <link rel="stylesheet" href="lib/prismjs/plugins/toolbar/prism-toolbar.css" />
    <style>
        .warning-txt {
            font-size: .9em;
        }

        .help {
            font-size: .8em;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <span class="navbar-brand">Plugin Finder Json Generator</span>
        </div>
    </nav>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Select Json File</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12">
                                <label>Select Existing</label>
                                <a class="help" title="Select an existing json file from your computer."><i class="far fa-question-circle text-info"></i></a>
                                <input type="file" class="form-control form-control-sm" id="selectJsonFileSelect" accept=".json" />
                            </div>
                            <div class="col-12 pt-2">
                                <label>Or URL</label>
                                <span class="help" title="Input the url to an existing json file to load it."><i class="far fa-question-circle text-info"></i></span>
                                <input type="url" class="form-control form-control-sm" id="selectJsonFileUrl" />
                            </div>
                            <div class="col-12 pt-2">
                                <label>Or Load Example</label>
                                <span class="help" title="Load an exmaple json file to see what it should look like."><i class="far fa-question-circle text-info"></i></span>
                                <button class="btn btn-sm btn-primary" onclick="loadExample()"><i class="fas fa-file-download"></i> Example</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card mt-3" id="pluginCard">
                    <div class="card-header">
                        <h5>Plugin Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12">
                                <label>Plugin Name</label>
                                <span class="help" title="The name of your plugin to display in Plugin Finder."><i class="far fa-question-circle text-info"></i></span>
                                <span class="d-none text-danger warning-txt" id="nameWarning">You must enter a name for your plugin.</span>
                                <input type="text" class="form-control form-control-sm" id="pluginNameText" required onchange="fieldChanged()" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 pt-2">
                                <label>Plugin Author</label>
                                <span class="help" title="The name of the author to display in Plugin Finder."><i class="far fa-question-circle text-info"></i></span>
                                <span class="d-none text-danger warning-txt" id="authorWarning">You must enter an author for your plugin.</span>
                                <input type="text" class="form-control form-control-sm" id="pluginAuthorText" required onchange="fieldChanged()" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 pt-2">
                                <label>Plugin Description</label>
                                <span class="help" title="A short (350 characters maximum) description of this plugin. Some themes cut this short."><i class="far fa-question-circle text-info"></i></span>
                                <textarea class="form-control form-control-sm" id="pluginDescriptionText" maxlength="350" onchange="fieldChanged()"></textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 pt-2">
                                <label>Documentation URL</label>
                                <span class="help" title="The url to a page with documentation for your plugin, optional."><i class="far fa-question-circle text-info"></i></span>
                                <span class="d-none text-danger warning-txt" id="docsWarning">This is not a valid url.</span>
                                <input type="url" class="form-control form-control-sm" id="pluginDocsText" onchange="fieldChanged()" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 pt-2">
                                <label>Github URL</label>
                                <span class="help" title="The url to the Github page of your plugin, optional."><i class="far fa-question-circle text-info"></i></span>
                                <span class="d-none text-danger warning-txt" id="githubWarning">This is not a valid url.</span>
                                <input type="url" class="form-control form-control-sm" id="pluginGithubUrl" onchange="fieldChanged()" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 pt-2">
                                <label>Nexus URL</label>
                                <span class="help" title="The url to the Nexus page of your plugin, optional."><i class="far fa-question-circle text-info"></i></span>
                                <span class="d-none text-danger warning-txt" id="nexusWarning">This is not a valid url.</span>
                                <input type="url" class="form-control form-control-sm" id="pluginNexusUrl" onchange="fieldChanged()" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card mt-3">
                    <div class="card-header">
                        <div class="row">
                            <div class="col-8">
                                <h5>Versions</h5>
                            </div>
                            <div class="col-4" style="text-align:right;">
                                <span class="help" title="Define all the releases of your plugin that you want people to be able to download through Plugin Finder."><i class="far fa-question-circle text-info"></i></span>
                                <button id="createVersionBtn" class="btn btn-sm btn-success"><i class="fa fa-plus"></i> Create</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12" id="versionColumn">

            </div>
            <div class="col-12">
                <div class="card mt-3" id="previewCard">
                    <div class="card-header">
                        <div class="row">
                            <div class="col-8">
                                <h5>Preview Json</h5>
                            </div>
                            <div class="col-4" style="text-align:right;">
                                <span class="help" title="Once you're satisfied, you can download your json file."><i class="far fa-question-circle text-info"></i></span>
                                <button id="saveJsonBtn" class="btn btn-success btn-sm disabled"><i class="fa fa-save"></i> Save</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <pre class="mt-0 mb-0"><code id="previewJson" class="language-json"></code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-3 d-none versionCard" id="versionTemplate">
        <div class="card-header">
            <div class="col-12 pt-2">
                <label>Plugin Version Number</label>
                <span class="help" title="The version number of this plugin release, this should be the same as the version number displayed within Mod Organizer's settings."><i class="far fa-question-circle text-info"></i></span>
                <span class="d-none text-danger warning-txt versionWarning">You must enter a version for this release.</span>
                <span class="d-none text-danger warning-txt versionInvalidWarning">This does not appear to be a valid version number.</span>
                <div class="input-group input-group-sm">
                    <input type="number" min="0" step="1" class="form-control form-control-sm majorVerNumText" style="max-width: 80px;" onchange="fieldChanged()" />
                    <input type="text" class="form-control form-control-sm disabled text-center" style="max-width: 30px;font-weight: bold;" disabled value="." />
                    <input type="number" min="0" step="1" class="form-control form-control-sm minorVerNumText" style="max-width: 80px;" onchange="fieldChanged()" />
                    <input type="text" class="form-control form-control-sm disabled text-center" style="max-width: 30px;font-weight: bold;" disabled value="." />
                    <input type="number" min="0" step="1" class="form-control form-control-sm subVerNumText" style="max-width: 80px;" onchange="fieldChanged()" />
                    <input type="text" class="form-control form-control-sm disabled text-center" style="max-width: 30px;font-weight: bold;" disabled value="." />
                    <input type="number" min="0" step="1" class="form-control form-control-sm subSubVerNumText" style="max-width: 80px;" onchange="fieldChanged()" />
                    <input type="text" class="form-control form-control-sm disabled text-center" style="max-width: 30px;font-weight: bold;" disabled value="-" />
                    <select class="form-control form-control-sm typeVerSelect" onchange="fieldChanged()">
                        <option value="">Final</option>
                        <option value="rc">Release Candidate</option>
                        <option value="b">Beta</option>
                        <option value="a">Alpha</option>
                    </select>
                    <button class="btn btn-sm btn-danger versionDeleteBtn" onclick="removeVersion(this)"><i class="fa fa-trash"></i> Delete</button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-12">
                    <label>Version Release Date</label>
                    <span class="help" title="The date of this release, if the date picker does not work, this must be in the format yyyy-MM-dd."><i class="far fa-question-circle text-info"></i></span>
                    <span class="d-none text-danger warning-txt releaseWarning">You must enter a release date for this release.</span>
                    <input type="date" class="form-control form-control-sm releaseDateText" onchange="fieldChanged()" />
                </div>
                <div class="col-6 pt-2">
                    <label>Min Supported Mod Organizer Version</label>
                    <span class="help" title="This release may work on Mod Organizer versions earlier than this, but they have not been tested. A warning will be displayed to anyone using versions of Mod Organizer earlier than this."><i class="far fa-question-circle text-info"></i></span>
                    <span class="d-none text-danger warning-txt minSupInvalidWarning">This does not appear to be a valid version number.</span>
                    <select class="form-control form-control-sm minSupportText" onchange="fieldChanged()">
                        <option value="">Unknown</option>
                        <option value="2.4.2">2.4.2</option>
                        <option value="2.4.2rc1.1">2.4.2 RC1.1</option>
                        <option value="2.4.1">2.4.1</option>
                        <option value="2.4.1rc2">2.4.1 RC2</option>
                        <option value="2.4.0">2.4.0</option>
                        <option value="2.4.0rc3">2.4.0 RC3</option>
                        <option value="2.4.0rc2">2.4.0 RC2</option>
                        <option value="2.4.0rc1.1">2.4.0 RC1.1</option>
                        <option value="2.4.0rc1">2.4.0 RC1</option>
                        <option value="2.3.2">2.3.2</option>
                        <option value="2.3.2rc2">2.3.2 RC2</option>
                        <option value="2.3.1">2.3.1</option>
                        <option value="2.3.0">2.3.0</option>
                        <option value="2.3.0rc2">2.3.0 RC2</option>
                        <option value="2.3.0rc1">2.3.0 RC1</option>
                        <option value="2.2.2.1">2.2.2.1</option>
                        <option value="2.2.2">2.2.2</option>
                        <option value="2.2.1">2.2.1</option>
                        <option value="2.2.0">2.2.0</option>
                        <option value="2.1.6">2.1.6</option>
                        <option value="2.1.5">2.1.5</option>
                        <option value="2.1.4">2.1.4</option>
                        <option value="2.1.3">2.1.3</option>
                        <option value="2.1.2">2.1.2</option>
                        <option value="2.1.1">2.1.1</option>
                        <option value="2.1.0.1">2.1.0.1</option>
                        <option value="2.1.0">2.1.0</option>
                    </select>
                </div>
                <div class="col-6 pt-2">
                    <label>Max Supported Mod Organizer Version</label>
                    <span class="help" title="This release may work on Mod Organizer versions newer than this, but they have not been tested. A warning will be displayed to anyone using versions of Mod Organizer newer than this."><i class="far fa-question-circle text-info"></i></span>
                    <span class="d-none text-danger warning-txt maxSupInvalidWarning">This does not appear to be a valid version number.</span>
                    <select class="form-control form-control-sm maxSupportText" onchange="fieldChanged()">
                        <option value="">Unknown</option>
                        <option value="2.4.2">2.4.2</option>
                        <option value="2.4.2rc1.1">2.4.2 RC1.1</option>
                        <option value="2.4.1">2.4.1</option>
                        <option value="2.4.1rc2">2.4.1 RC2</option>
                        <option value="2.4.0">2.4.0</option>
                        <option value="2.4.0rc3">2.4.0 RC3</option>
                        <option value="2.4.0rc2">2.4.0 RC2</option>
                        <option value="2.4.0rc1.1">2.4.0 RC1.1</option>
                        <option value="2.4.0rc1">2.4.0 RC1</option>
                        <option value="2.3.2">2.3.2</option>
                        <option value="2.3.2rc2">2.3.2 RC2</option>
                        <option value="2.3.1">2.3.1</option>
                        <option value="2.3.0">2.3.0</option>
                        <option value="2.3.0rc2">2.3.0 RC2</option>
                        <option value="2.3.0rc1">2.3.0 RC1</option>
                        <option value="2.2.2.1">2.2.2.1</option>
                        <option value="2.2.2">2.2.2</option>
                        <option value="2.2.1">2.2.1</option>
                        <option value="2.2.0">2.2.0</option>
                        <option value="2.1.6">2.1.6</option>
                        <option value="2.1.5">2.1.5</option>
                        <option value="2.1.4">2.1.4</option>
                        <option value="2.1.3">2.1.3</option>
                        <option value="2.1.2">2.1.2</option>
                        <option value="2.1.1">2.1.1</option>
                        <option value="2.1.0.1">2.1.0.1</option>
                        <option value="2.1.0">2.1.0</option>
                    </select>
                </div>
                <div class="col-6 pt-2">
                    <label>Min Working Mod Organizer Version</label>
                    <span class="help" title="This release will not work on Mod Organizer versions earlier than this. Users with versions of Mod Organizer earlier than this will not be able to install this release."><i class="far fa-question-circle text-info"></i></span>
                    <span class="d-none text-danger warning-txt minWorkInvalidWarning">This does not appear to be a valid version number.</span>
                    <select class="form-control form-control-sm minWorkingText" onchange="fieldChanged()">
                        <option value="">Unknown</option>
                        <option value="2.4.2">2.4.2</option>
                        <option value="2.4.2rc1.1">2.4.2 RC1.1</option>
                        <option value="2.4.1">2.4.1</option>
                        <option value="2.4.1rc2">2.4.1 RC2</option>
                        <option value="2.4.0">2.4.0</option>
                        <option value="2.4.0rc3">2.4.0 RC3</option>
                        <option value="2.4.0rc2">2.4.0 RC2</option>
                        <option value="2.4.0rc1.1">2.4.0 RC1.1</option>
                        <option value="2.4.0rc1">2.4.0 RC1</option>
                        <option value="2.3.2">2.3.2</option>
                        <option value="2.3.2rc2">2.3.2 RC2</option>
                        <option value="2.3.1">2.3.1</option>
                        <option value="2.3.0">2.3.0</option>
                        <option value="2.3.0rc2">2.3.0 RC2</option>
                        <option value="2.3.0rc1">2.3.0 RC1</option>
                        <option value="2.2.2.1">2.2.2.1</option>
                        <option value="2.2.2">2.2.2</option>
                        <option value="2.2.1">2.2.1</option>
                        <option value="2.2.0">2.2.0</option>
                        <option value="2.1.6">2.1.6</option>
                        <option value="2.1.5">2.1.5</option>
                        <option value="2.1.4">2.1.4</option>
                        <option value="2.1.3">2.1.3</option>
                        <option value="2.1.2">2.1.2</option>
                        <option value="2.1.1">2.1.1</option>
                        <option value="2.1.0.1">2.1.0.1</option>
                        <option value="2.1.0">2.1.0</option>
                    </select>
                </div>
                <div class="col-6 pt-2">
                    <label>Max Working Mod Organizer Version</label>
                    <span class="help" title="This release will not work on Mod Organizer versions newer than this. Users with versions of Mod Organizer newer than this will not be able to install this release."><i class="far fa-question-circle text-info"></i></span>
                    <span class="d-none text-danger warning-txt maxWorkInvalidWarning">This does not appear to be a valid version number.</span>
                    <select class="form-control form-control-sm maxWorkingText" onchange="fieldChanged()">
                        <option value="">Unknown</option>
                        <option value="2.4.2">2.4.2</option>
                        <option value="2.4.2rc1.1">2.4.2 RC1.1</option>
                        <option value="2.4.1">2.4.1</option>
                        <option value="2.4.1rc2">2.4.1 RC2</option>
                        <option value="2.4.0">2.4.0</option>
                        <option value="2.4.0rc3">2.4.0 RC3</option>
                        <option value="2.4.0rc2">2.4.0 RC2</option>
                        <option value="2.4.0rc1.1">2.4.0 RC1.1</option>
                        <option value="2.4.0rc1">2.4.0 RC1</option>
                        <option value="2.3.2">2.3.2</option>
                        <option value="2.3.2rc2">2.3.2 RC2</option>
                        <option value="2.3.1">2.3.1</option>
                        <option value="2.3.0">2.3.0</option>
                        <option value="2.3.0rc2">2.3.0 RC2</option>
                        <option value="2.3.0rc1">2.3.0 RC1</option>
                        <option value="2.2.2.1">2.2.2.1</option>
                        <option value="2.2.2">2.2.2</option>
                        <option value="2.2.1">2.2.1</option>
                        <option value="2.2.0">2.2.0</option>
                        <option value="2.1.6">2.1.6</option>
                        <option value="2.1.5">2.1.5</option>
                        <option value="2.1.4">2.1.4</option>
                        <option value="2.1.3">2.1.3</option>
                        <option value="2.1.2">2.1.2</option>
                        <option value="2.1.1">2.1.1</option>
                        <option value="2.1.0.1">2.1.0.1</option>
                        <option value="2.1.0">2.1.0</option>
                    </select>
                </div>
                <div class="col-12 pt-2">
                    <label>Plugin Download URL</label>
                    <span class="help" title="The url to a direct download of the zip file of this release to be installed. Opening the url in a browser should download your plugin, not open a webpage."><i class="far fa-question-circle text-info"></i></span>
                    <span class="d-none text-danger warning-txt downloadWarning">You must enter a download url for this release.</span>
                    <span class="d-none text-danger warning-txt downloadInvalidWarning">This is not a valid url.</span>
                    <span class="d-none text-danger warning-txt downloadZipWarning">This is not a valid mod download, the url must point to a .zip, or .7z file.</span>
                    <input type="url" class="form-control form-control-sm downloadUrlText" onchange="fieldChanged()" />
                </div>
                <div class="col-12 pt-2">
                    <label>Plugin Install Paths</label>
                    <span class="help" title="Paths relative to the root of the zip file. Any file or folder specified will be copied directly to Mod Organizer's plugins folder when this plugin is installed."><i class="far fa-question-circle text-info"></i></span>
                    <button class="btn btn-sm btn-primary pluginPathBtn" onclick="createArrayPath(this)"><i class="fa fa-plus"></i></button>
                    <span class="d-none text-danger warning-txt pathsWarning">You must enter at least one path for your plugin to be installable.</span>
                    <div class="textArrayContainer pluginPathsContainer">
                    </div>
                </div>
                <div class="col-12 pt-2">
                    <label>Localisation Install Paths</label>
                    <span class="help" title="Paths relative to the root of the zip file. Any file or folder specified will be copied directly to Mod Organizer's translations folder when this plugin is installed."><i class="far fa-question-circle text-info"></i></span>
                    <button class="btn btn-sm btn-primary localePathBtn" onclick="createArrayPath(this)"><i class="fa fa-plus"></i></button>
                    <div class="textArrayContainer localePathsContainer">
                    </div>
                </div>
                <div class="col-12 pt-2">
                    <label>Plugin Data Paths</label>
                    <span class="help" title="Paths relative to Mod Organizer's plugins folder. Any file or folder specified will be deleted (along with Localisation and Plugin paths) when this release is uninstalled."><i class="far fa-question-circle text-info"></i></span>
                    <button class="btn btn-sm btn-primary dataPathBtn" onclick="createArrayPath(this)"><i class="fa fa-plus"></i></button>
                    <div class="textArrayContainer dataPathsContainer">
                    </div>
                </div>
                <div class="col-12 pt-2">
                    <label>Release Notes</label>
                    <span class="help" title="A list of notes about this release."><i class="far fa-question-circle text-info"></i></span>
                    <button class="btn btn-sm btn-primary releaseNotesBtn" onclick="createArrayPath(this)"><i class="fa fa-plus"></i></button>
                    <div class="textArrayContainer releaseNotesContainer">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row d-none" id="textArrayTemplate">
        <div class="col-12 pt-2">
            <div class="input-group input-group-sm">
                <input type="text" class="form-control form-control-sm textArrayInput" onchange="fieldChanged()" />
                <button class="textArrayRemoveBtn btn btn-sm btn-danger" onclick="removeArrayPath(this)"><i class="fa fa-trash"></i></button>
            </div>
        </div>
    </div>

    <script src="lib/jquery/dist/jquery.min.js"></script>
    <script src="lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/prismjs/prism.js"></script>
    <script src="lib/prismjs/plugins/autoloader/prism-autoloader.js"></script>
    <script src="lib/prismjs/plugins/toolbar/prism-toolbar.js"></script>
    <script src="lib/prismjs/plugins/show-language/prism-show-language.js"></script>

    <script>
        const urlSearchParams = new URLSearchParams(window.location.search);
        const params = Object.fromEntries(urlSearchParams.entries());
        const versionRegex = /^([0-9]+)[.]?([0-9]*)[.]?([0-9]*)[.]?([0-9]*)?[._\-]?([A-Za-z0-9]*)/g;
        const exampleJson = {
            "Name": "Plugin Template",
            "Author": "Kezyma",
            "Description": "This is a template for a plugin json file to be used with Plugin Finder.",
            "DocsUrl": "https://github.com/Kezyma/ModOrganizer-Plugins/blob/main/readme/pluginfinder/readme.md",
            "NexusUrl": "https://www.nexusmods.com/skyrimspecialedition/mods/59869",
            "GithubUrl": "https://github.com/Kezyma/ModOrganizer-Plugins",
            "Versions": [
                {
                    "Version": "1.1.0a",
                    "Released": "2021-12-13",
                    "MinSupport": "2.4.2",
                    "MaxSupport": "2.4.2",
                    "MinWorking": "",
                    "MaxWorking": "2.4.2",
                    "ReleaseNotes": ["Initial alpha. Demo version."],
                    "DownloadUrl": "https://github.com/Kezyma/ModOrganizer-Plugins/releases/download/pluginfinder/pluginfinder.1.1.0.zip",
                    "PluginPath": ["pluginfinder"],
                    "LocalePath": [],
                    "DataPath": ["data/pluginfinder"]
                }
            ]
        }

        loadedJson = JSON.parse("{}");

        function loadExample() {
            loadedJson = exampleJson;
            updateForm();
            updatePreview();
            validate();
        }

        function getVersion(card) {
            var major = $(card).find(".majorVerNumText").val();
            var minor = $(card).find(".minorVerNumText").val();
            var sub = $(card).find(".subVerNumText").val();
            var subSub = $(card).find(".subSubVerNumText").val();
            var typ = $(card).find(".typeVerSelect").val();
            var res = "";
            if (major != "") {
                res += major;
            }
            if (minor != "") {
                res += "." + minor;
            }
            if (sub != "") {
                res += "." + sub;
            }
            if (subSub != "") {
                res += "." + subSub;
            }
            res += typ;
            return res;
        }

        function setVersion(card, versionText) {
            var versionMatch = versionRegex.exec(versionText);
            console.log(versionMatch);

            $(card).find(".majorVerNumText").val(versionMatch[1]);
            $(card).find(".minorVerNumText").val(versionMatch[2]);
            $(card).find(".subVerNumText").val(versionMatch[3]);
            $(card).find(".subSubVerNumText").val(versionMatch[4]);
            $(card).find(".typeVerSelect").val(versionMatch[5]);
        }

        function updateJson() {
            loadedJson["Name"] = $("#pluginNameText").val();
            loadedJson["Author"] = $("#pluginAuthorText").val();
            loadedJson["Description"] = $("#pluginDescriptionText").val();
            loadedJson["DocsUrl"] = $("#pluginDocsText").val();
            loadedJson["GithubUrl"] = $("#pluginGithubUrl").val();
            loadedJson["NexusUrl"] = $("#pluginNexusUrl").val();

            loadedJson["Versions"] = []
            $("#versionColumn").find(".versionCard").each(function (ix) {
                card = $("#versionColumn").find(".versionCard")[ix];
                var versionDef = {};
                versionDef["Version"] = getVersion(card);
                versionDef["Released"] = $(card).find(".releaseDateText").val();
                versionDef["MinSupport"] = $(card).find(".minSupportText").val();
                versionDef["MaxSupport"] = $(card).find(".maxSupportText").val();
                versionDef["MinWorking"] = $(card).find(".minWorkingText").val();
                versionDef["MaxWorking"] = $(card).find(".maxWorkingText").val();
                versionDef["DownloadUrl"] = $(card).find(".downloadUrlText").val();

                versionDef["PluginPath"] = []
                console.log(card);
                var pathCard = $(card).find(".pluginPathsContainer");
                console.log(pathCard);
                var pathinputs = $(pathCard).find(".textArrayInput");
                console.log(pathinputs);

                $(card).find(".pluginPathsContainer").find(".textArrayInput").each(function (ix) {
                    versionDef["PluginPath"].push($($(card).find(".pluginPathsContainer").find(".textArrayInput")[ix]).val());
                });

                versionDef["LocalePath"] = []
                $(card).find(".localePathsContainer").find(".textArrayInput").each(function (ix) {
                    versionDef["LocalePath"].push($($(card).find(".localePathsContainer").find(".textArrayInput")[ix]).val());
                });

                versionDef["DataPath"] = []
                $(card).find(".dataPathsContainer").find(".textArrayInput").each(function (ix) {
                    versionDef["DataPath"].push($($(card).find(".dataPathsContainer").find(".textArrayInput")[ix]).val());
                });

                versionDef["ReleaseNotes"] = []
                $(card).find(".releaseNotesContainer").find(".textArrayInput").each(function (ix) {
                    versionDef["ReleaseNotes"].push($($(card).find(".releaseNotesContainer").find(".textArrayInput")[ix]).val());
                });

                loadedJson["Versions"].push(versionDef);
            });

            updatePreview();
        }

        function updateForm() {
            $("#versionColumn").html("");

            $("#pluginNameText").val(loadedJson["Name"]);
            $("#pluginAuthorText").val(loadedJson["Author"]);
            $("#pluginDescriptionText").val(loadedJson["Description"]);
            $("#pluginDocsText").val(loadedJson["DocsUrl"]);
            $("#pluginGithubUrl").val(loadedJson["GithubUrl"]);
            $("#pluginNexusUrl").val(loadedJson["NexusUrl"]);
            for (version in loadedJson["Versions"]) {
                versionData = loadedJson["Versions"][version];
                versionCard = createVersion();
                setVersion(versionCard, versionData["Version"]);
                $(versionCard).find(".releaseDateText").val(versionData["Released"]);
                $(versionCard).find(".minSupportText").val(versionData["MinSupport"]);
                $(versionCard).find(".maxSupportText").val(versionData["MaxSupport"]);
                $(versionCard).find(".minWorkingText").val(versionData["MinWorking"]);
                $(versionCard).find(".maxWorkingText").val(versionData["MaxWorking"]);
                $(versionCard).find(".downloadUrlText").val(versionData["DownloadUrl"]);

                for (path in versionData["PluginPath"]) {
                    pathData = versionData["PluginPath"][path];
                    createArrayPath($(versionCard).find(".pluginPathBtn")).find(".textArrayInput").val(pathData);
                }
                for (path in versionData["LocalePath"]) {
                    pathData = versionData["LocalePath"][path];
                    createArrayPath($(versionCard).find(".localePathBtn")).find(".textArrayInput").val(pathData);
                }
                for (path in versionData["DataPath"]) {
                    pathData = versionData["DataPath"][path];
                    createArrayPath($(versionCard).find(".dataPathBtn")).find(".textArrayInput").val(pathData);
                }
                for (path in versionData["ReleaseNotes"]) {
                    pathData = versionData["ReleaseNotes"][path];
                    createArrayPath($(versionCard).find(".releaseNotesBtn")).find(".textArrayInput").val(pathData);
                }
            }
        }

        function fieldChanged() {
            validate();
            updateJson();
        }

        $(document).ready(function () {
            updatePreview();
            bindTooltips();
        });

        function bindTooltips() {
            $(".help").each(function (ix, help) {
                tt = new bootstrap.Tooltip(help);
            })
        }

        function updatePreview() {
            $("#previewJson").html(JSON.stringify(loadedJson, null, 4));
        }

        function downloadJson(content, fileName) {
            download(JSON.stringify(content, null, 4), fileName, 'text/json');
        }

        function download(content, fileName, contentType) {
            var a = document.createElement("a");
            var file = new Blob([content], { type: contentType });
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
        }

        function createVersion() {
            var newVersion = $("#versionTemplate").last().clone();
            newVersion.removeClass("d-none");
            newVersion.removeAttr('id');
            $("#versionColumn").prepend(newVersion);
            $("#saveJsonBtn").addClass("disabled");
            updatePreview();
            bindTooltips();
            return newVersion;
        }

        function removeVersion(button) {
            $(button).parent().parent().parent().parent().remove();
            validate();
            updatePreview();
            bindTooltips();
        }

        $("#selectJsonFileSelect").change(function (evt) {
            var file = evt.target.files[0];
            bindToFile(file);
        });

        function bindToFile(file) {
            $("#selectJsonFileUrl").val("");
            var reader = new FileReader();
            reader.onload = function (event) {
                loadedJson = JSON.parse(event.target.result);
                updateForm();
                updatePreview();
                validate();
            };
            reader.readAsText(file);
        }

        $("#selectJsonFileUrl").change(function (evt) {
            var url = $("#selectJsonFileUrl").val();
            bindToUrl(url);
        });

        function bindToUrl(url) {
            $("#selectJsonFileSelect").val("");
            $.getJSON(url, function (data) {
                loadedJson = data;
                updateForm();
                updatePreview();
                validate();
            });
        }

        $("#saveJsonBtn").click(function () {
            fileName = "plugindefinition.json";
            if ($("#selectJsonFileSelect").prop("files") != null && $("#selectJsonFileSelect").prop("files").length > 0) {
                fileName = $("#selectJsonFileSelect").prop("files")[0].name;
            }
            downloadJson(loadedJson, fileName);
        });

        $("#createVersionBtn").click(function () {
            createVersion();
        });

        function createArrayPath(button) {
            var container = $(button).parent().find(".textArrayContainer");
            var newField = $("#textArrayTemplate").last().clone();
            newField.removeClass("d-none");
            newField.removeAttr('id');
            container.append(newField);
            return newField;
        }

        function removeArrayPath(button) {
            $(button).parent().parent().parent().remove();
            validate();
        }

        function validate() {
            $(".warning-txt").addClass("d-none");
            var error = false;

            if ($("#pluginNameText").val() == "") {
                $("#nameWarning").removeClass("d-none");
                error = true;
            }
            if ($("#pluginAuthorText").val() == "") {
                $("#authorWarning").removeClass("d-none");
                error = true;
            }
            if ($("#pluginDocsText").val() != "" && !isValidHttpUrl($("#pluginDocsText").val())) {
                $("#docsWarning").removeClass("d-none");
                error = true;
            }
            if ($("#pluginGithubUrl").val() != "" && !isValidHttpUrl($("#pluginGithubUrl").val())) {
                $("#githubWarning").removeClass("d-none");
                error = true;
            }
            if ($("#pluginNexusUrl").val() != "" && !isValidHttpUrl($("#pluginNexusUrl").val())) {
                $("#nexusWarning").removeClass("d-none");
                error = true;
            }

            if ($(".versionCard").length > 1) {
                $("#versionColumn").find(".versionCard").each(function (ix, card) {
                    if (getVersion(card) == "") {
                        console.log("versionWarning error")
                        $(card).find(".versionWarning").removeClass("d-none");
                        error = true;
                    }
                    else if (!isVersionValid(getVersion(card))) {
                        console.log("versionInvalidWarning error")
                        $(card).find(".versionInvalidWarning").removeClass("d-none");
                        error = true;
                    }
                    if ($(card).find(".releaseDateText").val() == "") {
                        console.log("releaseWarning error")
                        $(card).find(".releaseWarning").removeClass("d-none");
                        error = true;
                    }
                    if ($(card).find(".downloadUrlText").val() == "") {
                        console.log("downloadWarning error")
                        $(card).find(".downloadWarning").removeClass("d-none");
                        error = true;
                    }
                    else if (!isValidHttpUrl($(card).find(".downloadUrlText").val())) {
                        console.log("downloadInvalidWarning error")
                        $(card).find(".downloadInvalidWarning").removeClass("d-none");
                        error = true;
                    }
                    else if (!isZippedFile($(card).find(".downloadUrlText").val())) {
                        console.log("downloadZipWarning error")
                        $(card).find(".downloadZipWarning").removeClass("d-none");
                        error = true;
                    }

                    if ($(card).find(".minSupportText").val() != "" && !isVersionValid($(card).find(".minSupportText").val())) {
                        console.log("minSupInvalidWarning error")
                        $(card).find(".minSupInvalidWarning").removeClass("d-none");
                        error = true;
                    }
                    if ($(card).find(".maxSupportText").val() != "" && !isVersionValid($(card).find(".maxSupportText").val())) {
                        console.log("maxSupInvalidWarning error")
                        $(card).find(".maxSupInvalidWarning").removeClass("d-none");
                        error = true;
                    }
                    if ($(card).find(".minWorkingText").val() != "" && !isVersionValid($(card).find(".minWorkingText").val())) {
                        console.log("minWorkInvalidWarning error")
                        $(card).find(".minWorkInvalidWarning").removeClass("d-none");
                        error = true;
                    }
                    if ($(card).find(".maxWorkingText").val() != "" && !isVersionValid($(card).find(".maxWorkingText").val())) {
                        console.log("maxWorkInvalidWarning error")
                        $(card).find(".maxWorkInvalidWarning").removeClass("d-none");
                        error = true;
                    }

                    var hasPath = false;
                    $(card).find(".pluginPathsContainer").find(".textArrayInput").each(function (ix, input) {
                        if ($(input).val() != "") {
                            hasPath = true;
                        }
                    });
                    if (!hasPath) {
                        $(card).find(".pathsWarning").removeClass("d-none");
                        console.log("pathsWarning error")
                        error = true;
                    }
                });
            }

            if (!error) {
                $("#saveJsonBtn").removeClass("disabled");
            }
            else {
                $("#saveJsonBtn").addClass("disabled");
            }
            return error;
        }


        function isVersionValid(string) {
            if (string.match(versionRegex)) {
                return true;
            }
            return false;
        }

        function isValidHttpUrl(string) {
            let url;
            try {
                url = new URL(string);
            }
            catch (_) {
                return false;
            }
            return url.protocol === "http:" || url.protocol === "https:";
        }

        function isZippedFile(string) {
            if (string.endsWith(".zip") || string.endsWith(".7z")) {
                return true;
            }
            return false;
        }
    </script>
</body>
</html>


